<script type="text/javascript">
    RED.nodes.registerType('google-service-account',{
        category: 'config',
        defaults: {
            name:         { value: undefined, required: true  },
            scope:        { value: undefined, required: false },
            way:          { value: "json",  required: false }
        },
        credentials: {
            projectId:    { value: undefined },
            client_email: { value: undefined },
            private_key:  { value: undefined },
            json:         { value: undefined }
        },
        label: function() {
            return this.name || "Google API credential";
        },
        oneditprepare: function() {
            
            if (this.scope && typeof (this.scope) !== "object") {
                this.scope = this.scope.split('\n');
            }

            $("#node-config-input-projectId").typedInput({      default: 'str',  types: ['str'],   type: 'str'  });
            $("#node-config-input-client_email").typedInput({   default: 'str',  types: ['str'],   type: 'str'  });
            // Note: private_key is now a textarea, no typedInput needed
            $("#node-config-input-json").typedInput({           default: 'json', types: ['json'],  type: 'json' });

            $("#node-config-input-way").change(function() {
                $(".display_fields").hide();
                $(".display_json").hide();
                if ($(this).val() === "json") {
                    $(".display_json").show();
                    $("#node-config-input-json").typedInput('show');
                }
                else {
                    $(".display_fields").show();
                    $("#node-config-input-projectId").typedInput('show');
                    $("#node-config-input-client_email").typedInput('show');
                    // Note: private_key is a textarea, no typedInput needed
                }
            });
            
            // Trigger initial display based on current way value
            $("#node-config-input-way").trigger('change');

            $("#node-config-input-check_sheets").click( function() {
                let url = "https://www.googleapis.com/auth/spreadsheets";
                if (!inList(url)) $("#node-input-container").editableList('addItem', { scope: url });
            }); 

            function inList (param) {
                let items = $("#node-input-container").editableList('items');
                let array = [];

                items.each(function(i) {
                    array.push($(this).find('.node-input-scope-name').val());
                });

                for (let item of array) if (item === param) return true;
                return false;
            }

            $("#node-input-container").css('min-height','100px').editableList({
                addItem: function ( row, index, data ) {
                    var newScope = data.scope,
                        scope = '';
                    if (newScope) scope =  newScope;
                    var hiddenField = $('<span/>', {}).appendTo(row);
                    var titleField =  $('<input/>', { class:"node-input-scope-name",  type:"text", style:"width:100%; ", value: scope})
                                                    .appendTo(row)
                                                    .typedInput({default: 'str' , types:['str'], type: 'str' });
                },
                sortable: false,
                removable: true
            });

            this.scope = this.scope || new Array();

            // Auto-add default Sheets scope if list is empty
            if (this.scope.length === 0) {
                $("#node-input-container").editableList('addItem', { 
                    scope: 'https://www.googleapis.com/auth/spreadsheets'
                });
            } else {
                for (var i=0; i<this.scope.length; i++) {
                    $("#node-input-container").editableList('addItem', { scope: this.scope[i] });
                }
            }
        },
        oneditsave: function(){
            // Scopes
            let results = new Array();
            let scope = $("#node-input-container").editableList('items');
            scope.each(function(i) {
                let newScope = $(this).find('.node-input-scope-name').val();
                if (newScope) results.push(newScope);
            });
            this.scope = results;
        }
    });
</script>

<style>
    .input-info { font-size: 12px; padding-left: 104px; font-style: italic; }
</style>

<script type="text/x-red" data-template-name="google-service-account">
    <div class="form-row">
        <label for="node-config-input-name"><i class="icon-tag"></i> Name</label>
        <input type="text" id="node-config-input-name" placeholder="My Service Account">
    </div>
    <br>

    <div class="form-row">
        <label for="node-config-input-way"><i class="fa fa-tasks"></i> Config</label>
        <select id="node-config-input-way" style="width:70%;">
            <option value="fields">Copy/Paste fields</option>
            <option value="json">Copy/Paste JSON file</option>
        </select>
    </div>

    <br>
    <div class="input-info display_fields" style="min-width:500px;">
        <p><strong>Setup Instructions:</strong></p>
        <ol style="padding-left: 20px; margin: 5px 0;">
            <li>Create a project in <a href="https://console.cloud.google.com" target="_blank">Google Cloud Console</a></li>
            <li>Enable the <strong>Google Sheets API</strong></li>
            <li>Go to <a href="https://console.cloud.google.com/apis/credentials" target="_blank">Credentials</a> and create a <strong>Service Account</strong></li>
            <li>Download the JSON key file</li>
            <li>Copy-paste the fields below from your JSON file</li>
            <li><strong>Important:</strong> Share your spreadsheet with the <code>client_email</code> address</li>
        </ol>
    </div>
    <div class="form-row display_fields">
        <label for="node-config-input-projectId"><i class="fa fa-lock"></i> project_id</label>
        <input type="text" id="node-config-input-projectId" placeholder="" style="width:70%">
    </div>
    <div class="form-row display_fields">
        <label for="node-config-input-private_key"><i class="fa fa-lock"></i> private_key</label>
        <textarea id="node-config-input-private_key" rows="5" placeholder="-----BEGIN PRIVATE KEY-----&#10;XXX...XXX&#10;-----END PRIVATE KEY-----" style="width:70%; font-family: monospace; font-size: 11px;"></textarea>
    </div>
    <div class="form-row display_fields">
        <label for="node-config-input-client_email"><i class="fa fa-lock"></i> client_email</label>
        <input type="text" id="node-config-input-client_email" placeholder="{user}@{project}.iam.gserviceaccount.com" style="width:70%">
    </div>

    <div class="display_fields" style="margin-left: 105px; margin-top: 10px; padding: 10px; border: 1px solid var(--red-ui-secondary-border-color, #ddd); border-left: 3px solid var(--red-ui-primary-color, #8f0000); background: var(--red-ui-secondary-background, #f9f9f9); max-width: 70%;">
        <strong>⚠️ Important:</strong> After creating the service account, you must <strong>share your spreadsheet</strong> 
        with the <code>client_email</code> address above and grant <strong>Editor</strong> (for write) 
        or <strong>Viewer</strong> (for read-only) permissions.
    </div>

    <div class="input-info display_json" style="min-width:450px;">
        <p><strong>Setup Instructions:</strong></p>
        <ol style="padding-left: 20px; margin: 5px 0;">
            <li>Create a project in <a href="https://console.cloud.google.com" target="_blank">Google Cloud Console</a></li>
            <li>Enable the <strong>Google Sheets API</strong></li>
            <li>Go to <a href="https://console.cloud.google.com/apis/credentials" target="_blank">Credentials</a> and create a <strong>Service Account</strong></li>
            <li>Download the JSON key file</li>
            <li>Copy-paste the entire JSON content below</li>
            <li><strong>Important:</strong> Share your spreadsheet with the service account email</li>
        </ol>
    </div>
    <div class="form-row display_json">
        <label for="node-config-input-json"><i class="fa fa-lock"></i> JSON</label>
        <input type="text" id="node-config-input-json" style="width:70%">
    </div>

    <div class="display_json" style="margin-left: 105px; margin-top: 10px; padding: 10px; border: 1px solid var(--red-ui-secondary-border-color, #ddd); border-left: 3px solid var(--red-ui-primary-color, #8f0000); background: var(--red-ui-secondary-background, #f9f9f9); max-width: 70%;">
        <strong>⚠️ Important:</strong> After creating the service account, you must <strong>share your spreadsheet</strong> 
        with the service account email address (from your JSON) and grant <strong>Editor</strong> (for write) 
        or <strong>Viewer</strong> (for read-only) permissions.
    </div>

    <br>
    <div class="form-row">
        <label><i class="fa fa-globe"></i> Scopes</label>
        <div style="display:inline-block; padding-left: 0px;">
            <p class="input-info" style="margin: 0;"> 
                OAuth2 scopes for API access. Default Sheets scope is added automatically.<br/>
                Add additional scopes only if using other Google APIs.
            </p>
            <button type="button" style="margin-top: 10px; margin-left:0px;" id="node-config-input-check_sheets">Add Sheets Scope</button>
        </div>
    </div>

    <div class="form-row" style="width:70%; margin-left:105px;">
        <ol id="node-input-container"></ol>
    </div>

</script>

<script type="text/x-red" data-help-name="google-service-account">
    <p>Configuration node for Google Service Account authentication to access the Google Sheets API with JWT-based authorization.</p>

    <h3>Details</h3>
    
    <h4>Setup Steps</h4>
    <ol>
        <li><strong>Create Google Cloud Project</strong>
            <ul>
                <li>Go to <a href="https://console.cloud.google.com" target="_blank">Google Cloud Console</a></li>
                <li>Create a new project or select an existing one</li>
            </ul>
        </li>
        <li><strong>Enable Google Sheets API</strong>
            <ul>
                <li>Navigate to "APIs & Services" → "Library"</li>
                <li>Search for "Google Sheets API" and enable it</li>
            </ul>
        </li>
        <li><strong>Create Service Account</strong>
            <ul>
                <li>Go to <a href="https://console.cloud.google.com/apis/credentials" target="_blank">Credentials</a></li>
                <li>Click "Create Credentials" → "Service Account"</li>
                <li>Fill in the details and create</li>
                <li>Click on the created service account</li>
                <li>Go to "Keys" tab → "Add Key" → "Create new key"</li>
                <li>Choose JSON format and download the file</li>
            </ul>
        </li>
        <li><strong>Configure in Node-RED</strong>
            <ul>
                <li><strong>Option 1 (Recommended):</strong> Copy/paste entire JSON file content</li>
                <li><strong>Option 2:</strong> Enter individual fields (project_id, private_key, client_email)</li>
            </ul>
        </li>
        <li><strong>⚠️ Share Your Spreadsheet</strong>
            <ul>
                <li>Open your Google Spreadsheet</li>
                <li>Click the "Share" button</li>
                <li>Add the <code>client_email</code> from your service account credentials</li>
                <li>Grant <strong>Editor</strong> permission (for write access) or <strong>Viewer</strong> (for read-only)</li>
                <li><strong>Without this step, you'll get "Permission denied" errors</strong></li>
            </ul>
        </li>
    </ol>

    <h4>OAuth2 Scopes</h4>
    <p>The default scope for Google Sheets (<code>https://www.googleapis.com/auth/spreadsheets</code>) 
    is automatically included. Add additional scopes only if you're integrating with other Google APIs.</p>

    <h4>Security Notes</h4>
    <ul>
        <li>Service accounts provide secure, server-to-server authentication without user interaction</li>
        <li>Private keys are stored securely in Node-RED's encrypted credentials system</li>
        <li>Never commit or share your service account JSON file publicly</li>
        <li>Each service account has a unique email address ending in <code>@*.iam.gserviceaccount.com</code></li>
        <li>Credentials are encrypted at rest and never exposed in flows</li>
    </ul>

    <h3>References</h3>
    <ul>
        <li><a href="https://cloud.google.com/iam/docs/service-accounts" target="_blank">Service Accounts Overview</a> - Google Cloud documentation</li>
        <li><a href="https://developers.google.com/workspace/guides/create-credentials" target="_blank">Create Credentials Guide</a> - Google Workspace setup</li>
        <li><a href="https://github.com/googleapis/google-auth-library-nodejs" target="_blank">Google Auth Library for Node.js</a> - authentication library</li>
    </ul>
</script>